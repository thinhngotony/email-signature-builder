<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goc Viet Email Signature Builder</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-muted: #64748b;
            --accent: #0f172a;
            --accent-blue: #2563eb;
            --input-bg: #f8fafc;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }

        .app {
            display: grid;
            grid-template-columns: 420px 1fr;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background: var(--card);
            border-right: 1px solid var(--border);
            padding: 24px;
            overflow-y: auto;
            max-height: 100vh;
        }

        .sidebar-header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .sidebar-header p {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
        }

        /* Form Sections */
        .form-section {
            margin-bottom: 24px;
        }

        .form-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            background: var(--input-bg);
            color: var(--text);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }

        .toggle-label {
            font-size: 13px;
            color: var(--text);
        }

        .toggle {
            position: relative;
            width: 40px;
            height: 22px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; right: 0; bottom: 0; left: 0;
            background: #cbd5e1;
            border-radius: 22px;
            transition: 0.2s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.2s;
        }

        .toggle input:checked + .toggle-slider {
            background: var(--accent-blue);
        }

        .toggle input:checked + .toggle-slider::before {
            transform: translateX(18px);
        }

        /* Social Links */
        .social-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .social-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-item input {
            border: none;
            background: transparent;
            font-size: 13px;
            padding: 4px;
        }

        .social-item input:focus {
            outline: none;
            box-shadow: none;
        }

        /* Upload Button */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: var(--accent-blue);
            background: rgba(37, 99, 235, 0.02);
        }

        .upload-area.has-image {
            border-style: solid;
            border-color: var(--accent-blue);
        }

        .upload-text {
            font-size: 13px;
            color: var(--text-muted);
        }

        .upload-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Preview Area */
        .preview-area {
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
        }

        .preview-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            padding: 32px;
            max-width: 740px;
            width: 100%;
        }

        .preview-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 16px;
            font-weight: 600;
        }

        /* Action Buttons */
        .actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            border: none;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #1e293b;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-secondary {
            background: white;
            color: var(--accent);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--input-bg);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .copy-status {
            margin-top: 12px;
            font-size: 13px;
            color: #16a34a;
            font-weight: 500;
            display: none;
        }

        /* Color Picker */
        .color-picker-row {
            display: flex;
            gap: 8px;
        }

        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-swatch:hover,
        .color-swatch.active {
            border-color: var(--accent);
            transform: scale(1.1);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .app {
                grid-template-columns: 1fr;
            }
            .sidebar {
                max-height: none;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
        }
    </style>
</head>
<body>

<div class="app">
    <!-- Sidebar: Form Controls -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>Email Signature Builder</h1>
            <p>Create professional signatures like Cisco, Google & more</p>
        </div>

        <!-- Personal Info -->
        <div class="form-section">
            <div class="form-section-title">Personal Information</div>
            <div class="form-row">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="fullName" value="Phan My Phuong" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label>Nickname (Optional)</label>
                    <input type="text" id="nickname" value="Alice" oninput="updatePreview()">
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label>Job Title</label>
                    <input type="text" id="jobTitle" value="General Director" oninput="updatePreview()">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" value="phuong.phan@gocviet.com.vn" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label>Mobile</label>
                    <input type="tel" id="mobile" value="+84 933 880 288" oninput="updatePreview()">
                </div>
            </div>
        </div>

        <!-- Company Info -->
        <div class="form-section">
            <div class="form-section-title">Company Information</div>
            <div class="form-row full">
                <div class="form-group">
                    <label>Company</label>
                    <input type="text" id="companyName" value="Goc Viet Office" oninput="updatePreview()">
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label>Address (Single Line)</label>
                    <input type="text" id="address" value="L17-11, 17th Floor, Vincom Center, 72 Le Thanh Ton, Ben Nghe Ward, District 1, Ho Chi Minh City, Vietnam" oninput="updatePreview()">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Office Phone</label>
                    <input type="tel" id="officePhone" value="+84 (28) 3911 7394" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label>Website</label>
                    <input type="url" id="website" value="www.gocviet.com.vn" oninput="updatePreview()">
                </div>
            </div>
        </div>

        <!-- Social Links -->
        <div class="form-section">
            <div class="form-section-title">Social Links</div>

            <div class="social-item">
                <div class="social-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="#0077b5"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                </div>
                <input type="text" id="linkedin" value="linkedin.com/in/phan-my-phuong" placeholder="LinkedIn URL" oninput="updatePreview()">
                <label class="toggle">
                    <input type="checkbox" id="linkedinShow" onchange="updatePreview()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="social-item">
                <div class="social-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="#1DA1F2"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
                </div>
                <input type="text" id="twitter" value="" placeholder="Twitter/X handle" oninput="updatePreview()">
                <label class="toggle">
                    <input type="checkbox" id="twitterShow" onchange="updatePreview()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="social-item">
                <div class="social-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="#25D366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                </div>
                <input type="text" id="whatsapp" value="+84933880288" placeholder="WhatsApp number" oninput="updatePreview()">
                <label class="toggle">
                    <input type="checkbox" id="whatsappShow" onchange="updatePreview()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="social-item">
                <div class="social-icon">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Icon_of_Zalo.svg/18px-Icon_of_Zalo.svg.png" alt="Zalo" width="18" height="18" style="border-radius:3px;">
                </div>
                <input type="text" id="zalo" value="" placeholder="Zalo phone number" oninput="updatePreview()">
                <label class="toggle">
                    <input type="checkbox" id="zaloShow" onchange="updatePreview()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Company Social Links -->
        <div class="form-section">
            <div class="form-section-title">Company Social</div>

            <div class="social-item">
                <div class="social-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="#1877F2"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                </div>
                <input type="text" id="facebook" value="" placeholder="Facebook page URL" oninput="updatePreview()">
                <label class="toggle">
                    <input type="checkbox" id="facebookShow" onchange="updatePreview()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="social-item">
                <div class="social-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="#FF0000"><path d="M23.498 6.186a3.016 3.016 0 00-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 00.502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 002.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 002.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                </div>
                <input type="text" id="youtube" value="" placeholder="YouTube channel URL" oninput="updatePreview()">
                <label class="toggle">
                    <input type="checkbox" id="youtubeShow" onchange="updatePreview()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Appearance -->
        <div class="form-section">
            <div class="form-section-title">Header Style</div>
            <div class="form-row full">
                <div class="form-group">
                    <label>Header Text (leave empty to hide)</label>
                    <input type="text" id="headerText" value="GOC VIET TSI CO., LTD" placeholder="e.g. COMPANY NAME or leave empty" oninput="updatePreview()">
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label>Tagline (shows in header)</label>
                    <input type="text" id="tagline" value="Specialized in supplying the whole range of world popular sauces and food products" oninput="updatePreview()">
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label>Slogan</label>
                    <input type="text" id="slogan" value="Our commitments your benefits" oninput="updatePreview()">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Header Color</label>
                    <div class="color-picker-row">
                        <div class="color-swatch active" style="background: #1B3A6B;" data-color="#1B3A6B" onclick="setHeaderColor(this)"></div>
                        <div class="color-swatch" style="background: #4A8BBE;" data-color="#4A8BBE" onclick="setHeaderColor(this)"></div>
                        <div class="color-swatch" style="background: #1a1a1a;" data-color="#1a1a1a" onclick="setHeaderColor(this)"></div>
                        <div class="color-swatch" style="background: #064e3b;" data-color="#064e3b" onclick="setHeaderColor(this)"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Brand Color</label>
                    <div class="color-picker-row">
                        <div class="color-swatch" style="background: #c41c3b;" data-color="#c41c3b" onclick="setBrandColor(this)"></div>
                        <div class="color-swatch active" style="background: #2563eb;" data-color="#2563eb" onclick="setBrandColor(this)"></div>
                        <div class="color-swatch" style="background: #059669;" data-color="#059669" onclick="setBrandColor(this)"></div>
                        <div class="color-swatch" style="background: #7c3aed;" data-color="#7c3aed" onclick="setBrandColor(this)"></div>
                    </div>
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label>Logo (Light/White for dark header)</label>
                    <div class="upload-area" id="logoUploadArea" onclick="document.getElementById('logoUpload').click()">
                        <div class="upload-text" id="logoUploadText">Click to upload logo</div>
                        <div class="upload-hint">PNG with transparent background recommended</div>
                    </div>
                    <input type="file" id="logoUpload" accept="image/*" style="display:none" onchange="handleLogoUpload(event)">
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label>Icon Style</label>
                    <select class="selector-select" id="iconStyle" onchange="updatePreview()">
                        <option value="text">Text Labels (Fallback)</option>
                        <option value="icons" selected>PNG Icons (Gmail &amp; All Clients)</option>
                    </select>
                </div>
            </div>
            <div class="toggle-group">
                <span class="toggle-label">Show Gradient Bar</span>
                <label class="toggle">
                    <input type="checkbox" id="showGradient" checked onchange="updatePreview()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="form-row full" style="margin-top:8px;">
                <div class="form-group">
                    <label>Gradient Style</label>
                    <select class="selector-select" id="gradientStyle" onchange="updatePreview()">
                        <option value="vibrant" selected>Vibrant Modern (Blue → Indigo → Purple)</option>
                        <option value="rainbow">Rainbow (Blue → Purple → Pink → Orange)</option>
                        <option value="glow">Luminous Glow (Blue → Light Blue → Blue)</option>
                        <option value="bold">Bold Confident (Deep Blue → Blue → Indigo)</option>
                        <option value="luxury">Luxury (Blue → Royal → Violet)</option>
                    </select>
                </div>
            </div>
            <div class="form-row full" style="margin-top:12px;">
                <div class="form-group">
                    <label>Bottom Tagline (leave empty to hide)</label>
                    <input type="text" id="bottomTagline" value="Premium Vietnamese Sauces | Global Quality Standards | Est. 2010" placeholder="e.g. Quality Products | Since 2010" oninput="updatePreview()">
                </div>
            </div>
        </div>

    </div>

    <!-- Preview Area -->
    <div class="preview-area">
        <div class="preview-container">
            <div class="preview-label">Signature Preview</div>
            <div id="signaturePreview"></div>

            <div class="actions">
                <button class="btn btn-primary" onclick="copySignature()">Copy to Clipboard</button>
                <button class="btn btn-secondary" onclick="downloadHTML()">Download HTML</button>
            </div>
            <div class="copy-status" id="copyStatus">Copied! Paste in Gmail or Outlook signature settings.</div>
        </div>
    </div>
</div>

<script>
    let logoDataURL = null;
    let headerColor = '#1B3A6B';
    let brandColor = '#2563eb';

    const labelStyle = "color:#94a3b8;font-size:11px;font-weight:600;font-family:'Segoe UI',Roboto,Arial,sans-serif;margin-right:5px;";
    const iconCdn = "https://cdn.jsdelivr.net/gh/dmhendricks/signature-social-icons/icons/round-flat-filled/50px";
    const iconStyle = 'width:16px;height:16px;vertical-align:middle;margin-right:5px;border-radius:50%;';

    // Text labels - Gmail compatible, enterprise-style full word labels (fallback)
    const textLabels = {
        email: `<span style="${labelStyle}">Email</span>`,
        phone: `<span style="${labelStyle}">Mobile</span>`,
        office: `<span style="${labelStyle}">Tel</span>`,
        globe: `<span style="${labelStyle}">Web</span>`,
        location: `<span style="${labelStyle}">Addr</span>`,
        linkedin: `<span style="${labelStyle}">LinkedIn</span>`,
        twitter: `<span style="${labelStyle}">X</span>`,
        whatsapp: `<span style="${labelStyle}">WhatsApp</span>`,
        facebook: `<span style="${labelStyle}">Facebook</span>`,
        youtube: `<span style="${labelStyle}">YouTube</span>`,
        zalo: `<span style="color:#0068FF;font-size:11px;font-weight:600;font-family:'Segoe UI',Roboto,Arial,sans-serif;margin-right:5px;">Zalo</span>`
    };

    // Hosted PNG icons via jsDelivr CDN - works in Gmail, Outlook, Apple Mail
    const pngIcons = {
        email: `<img src="${iconCdn}/mail.png" alt="Email" style="${iconStyle}">`,
        phone: `<img src="${iconCdn}/call.png" alt="Mobile" style="${iconStyle}">`,
        office: `<img src="${iconCdn}/call.png" alt="Tel" style="${iconStyle}">`,
        globe: `<img src="https://img.icons8.com/color/48/internet.png" alt="Web" style="${iconStyle}">`,
        location: `<img src="${iconCdn}/www.png" alt="Addr" style="${iconStyle}">`,
        linkedin: `<img src="${iconCdn}/linkedin.png" alt="LinkedIn" style="${iconStyle}">`,
        twitter: `<img src="${iconCdn}/twitter.png" alt="X" style="${iconStyle}">`,
        whatsapp: `<img src="${iconCdn}/whatsapp.png" alt="WhatsApp" style="${iconStyle}">`,
        facebook: `<img src="${iconCdn}/facebook.png" alt="Facebook" style="${iconStyle}">`,
        youtube: `<img src="${iconCdn}/youtube.png" alt="YouTube" style="${iconStyle}">`,
        zalo: `<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Icon_of_Zalo.svg/50px-Icon_of_Zalo.svg.png" alt="Zalo" style="${iconStyle}">`
    };

    // C1 Fix: XSS sanitization for all user inputs
    function esc(str) {
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    }

    // C2 Fix: Compute lighter variant of header color for gradient
    function lightenColor(hex, amount) {
        hex = hex.replace('#', '');
        const r = Math.min(255, parseInt(hex.substring(0, 2), 16) + amount);
        const g = Math.min(255, parseInt(hex.substring(2, 4), 16) + amount);
        const b = Math.min(255, parseInt(hex.substring(4, 6), 16) + amount);
        return '#' + [r, g, b].map(v => v.toString(16).padStart(2, '0')).join('');
    }

    function setHeaderColor(el) {
        el.parentElement.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
        el.classList.add('active');
        headerColor = el.dataset.color;
        updatePreview();
    }

    // M2 Fix: Strip all non-digit/non-plus chars for tel: URIs (RFC 3966)
    function cleanTel(num) {
        return num.replace(/[^\d+]/g, '');
    }

    // M3 Fix: Normalize URL - strip any protocol prefix
    function cleanUrl(url) {
        return url.replace(/^https?:\/\//, '').replace(/^www\./, 'www.');
    }

    function formatPhone(num) {
        if (/[\s\(\)]/.test(num)) return num;
        const raw = num.replace(/[\-]/g, '');
        if (raw.startsWith('+') && raw.length >= 10) {
            const cc = raw.startsWith('+84') ? '+84' : raw.slice(0, raw.length >= 12 ? 3 : 2);
            const rest = raw.slice(cc.length);
            return cc + ' ' + rest.replace(/(\d{3})(?=\d)/g, '$1 ').trim();
        }
        return num;
    }

    function setBrandColor(el) {
        el.parentElement.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
        el.classList.add('active');
        brandColor = el.dataset.color;
        updatePreview();
    }

    function handleLogoUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            logoDataURL = e.target.result;
            document.getElementById('logoUploadText').textContent = file.name;
            document.getElementById('logoUploadArea').classList.add('has-image');
            updatePreview();
        };
        reader.readAsDataURL(file);
    }

    function generateSignature() {
        const raw = {
            fullName: document.getElementById('fullName').value,
            nickname: document.getElementById('nickname').value,
            jobTitle: document.getElementById('jobTitle').value,
            email: document.getElementById('email').value,
            mobile: document.getElementById('mobile').value,
            companyName: document.getElementById('companyName').value,
            address: document.getElementById('address').value,
            officePhone: document.getElementById('officePhone').value,
            website: document.getElementById('website').value,
            tagline: document.getElementById('tagline').value,
            linkedin: document.getElementById('linkedin').value,
            linkedinShow: document.getElementById('linkedinShow').checked,
            twitter: document.getElementById('twitter').value,
            twitterShow: document.getElementById('twitterShow').checked,
            whatsapp: document.getElementById('whatsapp').value,
            whatsappShow: document.getElementById('whatsappShow').checked,
            facebook: document.getElementById('facebook').value,
            facebookShow: document.getElementById('facebookShow').checked,
            youtube: document.getElementById('youtube').value,
            youtubeShow: document.getElementById('youtubeShow').checked,
            zalo: document.getElementById('zalo').value,
            zaloShow: document.getElementById('zaloShow').checked,
            showGradient: document.getElementById('showGradient').checked,
            gradientStyle: document.getElementById('gradientStyle').value,
            headerText: document.getElementById('headerText').value,
            slogan: document.getElementById('slogan').value,
            iconStyle: document.getElementById('iconStyle').value,
            bottomTagline: document.getElementById('bottomTagline').value
        };

        // C1 Fix: Sanitize all text inputs
        const data = {};
        for (const [k, v] of Object.entries(raw)) {
            data[k] = typeof v === 'string' ? esc(v) : v;
        }

        // Select icon set based on user preference
        const icons = data.iconStyle === 'icons' ? pngIcons : textLabels;

        // C2 Fix: Use headerColor variable + computed lighter variant for gradient
        const headerLight = lightenColor(headerColor, 80);

        // M5 Fix: Use brandColor for link colors
        const linkColor = brandColor;

        // Logo section - supports: logo only, text only, logo + text, or empty
        // C3 Fix: Use solid hex colors instead of rgba() for Outlook compatibility
        let logoSection = '';

        if (logoDataURL && data.headerText) {
            logoSection = `<table cellpadding="0" cellspacing="0" border="0"><tr>
                <td style="padding-right:16px;vertical-align:middle;">
                  <img src="${logoDataURL}" alt="${data.companyName}" style="height:50px;width:auto;display:block;">
                </td>
                <td style="vertical-align:middle;">
                  <div style="font-size:20px;font-weight:700;color:#F2F2F2;letter-spacing:2px;">${data.headerText}</div>
                  ${data.tagline ? `<div style="font-size:12px;color:#E6E6E6;margin-top:4px;letter-spacing:0.3px;line-height:1.4;">${data.tagline}</div>` : ''}
                  ${data.slogan ? `<div style="font-size:10px;color:#B3B3B3;margin-top:6px;font-style:italic;letter-spacing:0.5px;">&mdash; ${data.slogan}</div>` : ''}
                </td>
              </tr></table>`;
        } else if (logoDataURL) {
            logoSection = `<table cellpadding="0" cellspacing="0" border="0"><tr>
                <td style="padding-right:16px;vertical-align:middle;">
                  <img src="${logoDataURL}" alt="${data.companyName}" style="height:50px;width:auto;display:block;">
                </td>
                <td style="vertical-align:middle;">
                  ${data.tagline ? `<div style="font-size:12px;color:#E6E6E6;letter-spacing:0.3px;line-height:1.4;">${data.tagline}</div>` : ''}
                </td>
              </tr></table>`;
        } else if (data.headerText) {
            logoSection = `<table cellpadding="0" cellspacing="0" border="0"><tr>
                <td style="vertical-align:middle;">
                  <div style="font-size:20px;font-weight:700;color:#F2F2F2;letter-spacing:2px;">${data.headerText}</div>
                  ${data.tagline ? `<div style="font-size:12px;color:#E6E6E6;margin-top:4px;letter-spacing:0.3px;line-height:1.4;">${data.tagline}</div>` : ''}
                  ${data.slogan ? `<div style="font-size:10px;color:#B3B3B3;margin-top:6px;font-style:italic;letter-spacing:0.5px;">&mdash; ${data.slogan}</div>` : ''}
                </td>
              </tr></table>`;
        } else {
            logoSection = '';
        }

        // Social links — M5 Fix: use brandColor for link colors
        let socialLinks = '';
        if (data.linkedinShow && data.linkedin) {
            const linkedinClean = cleanUrl(raw.linkedin);
            const linkedinDisplay = esc(linkedinClean.replace('linkedin.com/in/','').replace('linkedin.com/company/',''));
            socialLinks += `<tr><td style="padding:2px 0;">${icons.linkedin}<a href="https://${esc(linkedinClean)}" style="font-size:12px;color:${linkColor};text-decoration:none;">${linkedinDisplay}</a></td></tr>`;
        }
        if (data.twitterShow && data.twitter) {
            const handle = esc(raw.twitter.replace('@',''));
            socialLinks += `<tr><td style="padding:2px 0;">${icons.twitter}<a href="https://x.com/${handle}" style="font-size:12px;color:${linkColor};text-decoration:none;">@${handle}</a></td></tr>`;
        }
        if (data.whatsappShow && data.whatsapp) {
            socialLinks += `<tr><td style="padding:2px 0;">${icons.whatsapp}<a href="https://wa.me/${cleanTel(raw.whatsapp).replace('+','')}" style="font-size:12px;color:${linkColor};text-decoration:none;">${esc(formatPhone(raw.whatsapp))}</a></td></tr>`;
        }
        if (data.zaloShow && data.zalo) {
            socialLinks += `<tr><td style="padding:2px 0;">${icons.zalo}<a href="https://zalo.me/${cleanTel(raw.zalo).replace('+','')}" style="font-size:12px;color:${linkColor};text-decoration:none;">${esc(formatPhone(raw.zalo))}</a></td></tr>`;
        }

        // Gradient bar with style options
        const gradientStyles = {
            vibrant:  { css: 'linear-gradient(90deg,#3B82F6 0%,#6366F1 50%,#A855F7 100%)', fallback: '#6366F1' },
            rainbow:  { css: 'linear-gradient(90deg,#0066cc 0%,#6366f1 25%,#a855f7 50%,#ec4899 75%,#f97316 100%)', fallback: '#6366f1' },
            glow:     { css: 'linear-gradient(90deg,#2E5DFF 0%,#4B9EFF 50%,#2E5DFF 100%)', fallback: '#4B9EFF' },
            bold:     { css: 'linear-gradient(90deg,#1E40AF 0%,#2563EB 50%,#4F46E5 100%)', fallback: '#2563EB' },
            luxury:   { css: 'linear-gradient(90deg,#3F83F8 0%,#2E5DFF 50%,#5E46BF 100%)', fallback: '#2E5DFF' }
        };
        const gStyle = gradientStyles[data.gradientStyle] || gradientStyles.vibrant;
        const gradientBar = data.showGradient
            ? `<table cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td bgcolor="${gStyle.fallback}" style="height:3px;background:${gStyle.css};background-color:${gStyle.fallback};font-size:1px;line-height:1px;">&nbsp;</td></tr></table>`
            : '';

        // M1 Fix: Use width="660" attribute for Outlook instead of just max-width
        const websiteClean = cleanUrl(raw.website);

        return `<table cellpadding="0" cellspacing="0" border="0" width="660" style="font-family:'Segoe UI',Roboto,Arial,sans-serif;max-width:660px;width:100%;">
  <tr><td style="padding:0;">

    <!-- Header — C2 Fix: uses headerColor variable + gradient with bgcolor fallback -->
    ${logoSection ? `<table cellpadding="0" cellspacing="0" border="0" width="100%" bgcolor="${headerColor}" style="background:linear-gradient(135deg, ${headerColor} 0%, ${headerLight} 100%);background-color:${headerColor};">
      <tr><td bgcolor="${headerColor}" style="padding:14px 20px;background:linear-gradient(135deg, ${headerColor} 0%, ${headerLight} 100%);background-color:${headerColor};">${logoSection}</td></tr>
    </table>` : ''}

    <!-- Gradient Bar -->
    ${gradientBar}

    <!-- Content -->
    <table cellpadding="0" cellspacing="0" border="0" width="100%" bgcolor="#ffffff" style="background-color:#ffffff;">
      <tr><td style="padding:16px 20px;">
        <table cellpadding="0" cellspacing="0" border="0" width="100%">
          <tr>
            <!-- Left: Personal -->
            <td style="vertical-align:top;width:46%;padding-right:14px;">
              <div style="font-size:11px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">Contact</div>
              <div style="font-size:15px;font-weight:700;color:#1e293b;margin-bottom:1px;">${data.fullName}${data.nickname ? ` <span style="font-weight:400;color:#64748b;">(${data.nickname})</span>` : ''}</div>
              <div style="font-size:11px;color:#c41c3b;font-weight:600;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:10px;">${data.jobTitle}</div>
              <table cellpadding="0" cellspacing="0" border="0">
                <tr><td style="padding:2px 0;">${icons.phone}<a href="tel:${cleanTel(raw.mobile)}" style="font-size:12px;color:#334155;text-decoration:none;">${esc(formatPhone(raw.mobile))}</a></td></tr>
                <tr><td style="padding:2px 0;">${icons.email}<a href="mailto:${data.email}" style="font-size:12px;color:${linkColor};text-decoration:none;">${data.email}</a></td></tr>
                ${socialLinks}
              </table>
            </td>

            <!-- Divider -->
            <td style="width:1px;background:#e2e8f0;font-size:0;line-height:0;" width="1">&nbsp;</td>

            <!-- Right: Office -->
            <td style="vertical-align:top;width:54%;padding-left:14px;">
              <div style="font-size:11px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">Office</div>
              <div style="font-size:15px;font-weight:700;color:#1e293b;margin-bottom:1px;">${data.companyName}</div>
              <div style="font-size:11px;color:#475569;line-height:1.4;margin-bottom:10px;">${data.address}</div>
              <table cellpadding="0" cellspacing="0" border="0">
                <tr><td style="padding:2px 0;">${icons.office}<a href="tel:${cleanTel(raw.officePhone)}" style="font-size:12px;color:#334155;text-decoration:none;">${esc(formatPhone(raw.officePhone))}</a></td></tr>
                <tr><td style="padding:2px 0;">${icons.globe}<a href="https://${esc(websiteClean)}" style="font-size:12px;color:${linkColor};text-decoration:none;">${esc(raw.website)}</a></td></tr>
                ${data.facebookShow && data.facebook ? `<tr><td style="padding:2px 0;">${icons.facebook}<a href="https://${esc(cleanUrl(raw.facebook))}" style="font-size:12px;color:${linkColor};text-decoration:none;">${esc(cleanUrl(raw.facebook).replace('www.facebook.com/','').replace('facebook.com/',''))}</a></td></tr>` : ''}
                ${data.youtubeShow && data.youtube ? `<tr><td style="padding:2px 0;">${icons.youtube}<a href="https://${esc(cleanUrl(raw.youtube))}" style="font-size:12px;color:${linkColor};text-decoration:none;">${esc(cleanUrl(raw.youtube).replace('www.youtube.com/','').replace('youtube.com/',''))}</a></td></tr>` : ''}
              </table>
            </td>
          </tr>
        </table>
      </td></tr>
    </table>

    <!-- Bottom Tagline -->
    ${data.bottomTagline ? `<table cellpadding="0" cellspacing="0" border="0" width="100%" bgcolor="#f8fafc" style="background-color:#f8fafc;border-top:1px solid #e2e8f0;">
      <tr><td style="padding:8px 20px;text-align:center;">
        <span style="font-size:11px;color:#94a3b8;letter-spacing:0.3px;">${data.bottomTagline}</span>
      </td></tr>
    </table>` : ''}

  </td></tr>
</table>`;
    }

    function updatePreview() {
        document.getElementById('signaturePreview').innerHTML = generateSignature();
    }

    function copySignature() {
        // Use execCommand with selection (most reliable for email clients)
        const container = document.getElementById('signaturePreview');
        const range = document.createRange();
        range.selectNodeContents(container);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);

        try {
            document.execCommand('copy');
            selection.removeAllRanges();
            showCopyStatus();
        } catch (err) {
            // Fallback: Clipboard API with both text/html and text/plain
            const html = generateSignature();
            const htmlBlob = new Blob([html], { type: 'text/html' });
            const textBlob = new Blob([container.innerText], { type: 'text/plain' });
            navigator.clipboard.write([new ClipboardItem({
                'text/html': htmlBlob,
                'text/plain': textBlob
            })]).then(showCopyStatus).catch(() => {
                alert('Copy failed. Please select the signature manually and copy.');
            });
        }
    }

    function showCopyStatus() {
        const status = document.getElementById('copyStatus');
        status.style.display = 'block';
        setTimeout(() => status.style.display = 'none', 3000);
    }

    function downloadHTML() {
        const sig = generateSignature();
        const full = `<!DOCTYPE html>\n<html>\n<head><meta charset="UTF-8"><title>Email Signature</title></head>\n<body style="margin:20px;background:#f5f5f5;">\n${sig}\n</body>\n</html>`;
        const blob = new Blob([full], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'email-signature.html';
        a.click();
        URL.revokeObjectURL(url);
    }

    // Initialize
    updatePreview();
</script>

</body>
</html>
